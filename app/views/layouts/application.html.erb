<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Bandmgr" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <%= heroicon_stylesheet %>

    <script>
      (function() {
        var storedTheme = localStorage.getItem("theme");
        if (storedTheme === "dark") {
          document.documentElement.classList.add("theme-dark");
        }
      })();
    </script>
  </head>

  <body class="bg-slate-50 text-slate-900">
    <div class="min-h-screen md:flex">
      <aside class="hidden w-64 flex-col border-r border-slate-200 bg-white px-5 py-6 md:flex">
        <div class="flex items-center justify-between">
          <%= link_to "bandmgr", root_path, class: "text-lg font-semibold tracking-tight text-slate-900" %>
        </div>
        <% if current_account %>
          <p class="mt-2 text-xs uppercase tracking-wide text-slate-400"><%= current_account.name %></p>
        <% end %>

        <nav class="mt-8 text-sm text-slate-700">
          <div class="space-y-2">
            <%= link_to "Bands", bands_path, class: "block rounded-md px-3 py-2 hover:bg-slate-100" %>
            <%= link_to "Songs", songs_path, class: "block rounded-md px-3 py-2 hover:bg-slate-100" %>
            <%= link_to "Setlists", setlists_path, class: "block rounded-md px-3 py-2 hover:bg-slate-100" %>
            <%= link_to "Events", events_path, class: "block rounded-md px-3 py-2 hover:bg-slate-100" %>
            <% if preferred_band %>
              <%= link_to "Chat", chat_band_path(preferred_band), class: "block rounded-md px-3 py-2 hover:bg-slate-100" %>
            <% else %>
              <span class="block rounded-md px-3 py-2 text-slate-400" aria-disabled="true">Chat</span>
            <% end %>
            <span class="block rounded-md px-3 py-2 text-slate-400" aria-disabled="true">Branding</span>
            <span class="block rounded-md px-3 py-2 text-slate-400" aria-disabled="true">Inventory</span>
            <span class="block rounded-md px-3 py-2 text-slate-400" aria-disabled="true">Technical</span>
            <span class="block rounded-md px-3 py-2 text-slate-400" aria-disabled="true">Finance</span>
          </div>
        </nav>

        <div class="mt-auto space-y-4 pt-6 text-sm text-slate-600">
          <% if current_account_membership&.admin? || current_account_membership&.owner? %>
            <%= link_to "Admin", admin_path, class: "block rounded-md border border-slate-200 bg-white px-3 py-2 text-center text-sm font-semibold text-slate-700 hover:border-slate-300 hover:text-slate-900" %>
          <% end %>
          <div class="flex items-center justify-between rounded-md border border-slate-200 bg-white px-3 py-2">
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-500">Dark mode</span>
            <button type="button" id="theme-toggle" class="rounded-full border border-slate-300 px-3 py-1 text-xs font-semibold text-slate-700 hover:border-slate-400 hover:text-slate-900" aria-pressed="false">
              Off
            </button>
          </div>
          <% if current_user %>
            <%= button_to "Sign out", session_path, method: :delete, class: "w-full rounded-md border border-slate-300 px-3 py-2 text-slate-700 hover:border-slate-400 hover:text-slate-900" %>
          <% end %>
        </div>
      </aside>

      <div class="flex-1">
        <header class="border-b border-slate-200 bg-white md:hidden">
          <div class="flex items-center justify-between px-6 py-4">
            <%= link_to "bandmgr", root_path, class: "text-lg font-semibold tracking-tight text-slate-900" %>
            <% if current_user %>
              <%= button_to "Sign out", session_path, method: :delete, class: "rounded-full border border-slate-300 px-3 py-1 text-sm text-slate-700 hover:border-slate-400 hover:text-slate-900" %>
            <% end %>
          </div>
          <nav class="px-6 pb-4 text-sm text-slate-600">
            <div class="flex flex-wrap gap-3">
              <%= link_to "Bands", bands_path, class: "hover:text-slate-900" %>
              <%= link_to "Songs", songs_path, class: "hover:text-slate-900" %>
              <%= link_to "Setlists", setlists_path, class: "hover:text-slate-900" %>
              <%= link_to "Events", events_path, class: "hover:text-slate-900" %>
              <% if preferred_band %>
                <%= link_to "Chat", chat_band_path(preferred_band), class: "hover:text-slate-900" %>
              <% else %>
                <span class="text-slate-400">Chat</span>
              <% end %>
              <% if current_account_membership&.admin? || current_account_membership&.owner? %>
                <%= link_to "Admin", admin_path, class: "hover:text-slate-900" %>
              <% end %>
              <span class="text-slate-400">Branding</span>
              <span class="text-slate-400">Inventory</span>
              <span class="text-slate-400">Technical</span>
              <span class="text-slate-400">Finance</span>
            </div>
          </nav>
        </header>

        <main class="mx-auto w-full max-w-6xl px-6 py-8">
          <% flash.each do |type, message| %>
            <div class="mb-4 rounded-md border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700">
              <%= message %>
            </div>
          <% end %>
          <%= yield %>
        </main>
      </div>
    </div>

    <script>
      (function() {
        var toggle = document.getElementById("theme-toggle");
        if (!toggle) return;

        function applyState(isDark) {
          toggle.setAttribute("aria-pressed", isDark ? "true" : "false");
          toggle.textContent = isDark ? "On" : "Off";
        }

        applyState(document.documentElement.classList.contains("theme-dark"));

        toggle.addEventListener("click", function() {
          var isDark = document.documentElement.classList.toggle("theme-dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
          applyState(isDark);
        });
      })();
    </script>

    <script>
      (function() {
        document.addEventListener("click", function(event) {
          var button = event.target.closest("[data-copy-target]");
          if (!button) return;

          var target = button.getAttribute("data-copy-target");
          var node = document.querySelector(target);
          if (!node) return;

          var text = node.textContent.trim();
          var icon = button.querySelector("[data-copy-icon]");

          function flash() {
            if (!icon) return;
            var original = icon.textContent;
            icon.textContent = "âœ“";
            button.classList.add("text-emerald-600");
            setTimeout(function() {
              icon.textContent = original;
              button.classList.remove("text-emerald-600");
            }, 1200);
          }

          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(flash).catch(function() {});
            return;
          }

          var textarea = document.createElement("textarea");
          textarea.value = text;
          textarea.setAttribute("readonly", "");
          textarea.style.position = "absolute";
          textarea.style.left = "-9999px";
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          textarea.setSelectionRange(0, textarea.value.length);
          var ok = document.execCommand("copy");
          document.body.removeChild(textarea);
          if (ok) flash();
        });
      })();
    </script>
  </body>
</html>
